<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="menu">
    <!-- 메뉴 전체 조회 - 재준 -->
    <select id="findMenuAll" resultType="menu">
        select
            *
        from
            tb_menu
    </select>

    <!-- 메뉴 식별번호로 메뉴 한개 조회 - 재준 -->
    <select id="findByMenuNo" resultType="menu">
        select
            *
        from
            tb_menu
        where
            menu_no = #{menuNo}
    </select>

    <!-- 메뉴 추가 - 재준 -->
    <insert id="insertMenu">
        insert into
            tb_menu
        values (
            ('menu' || lpad(seq_tb_menu_menu_no.nextval,3,0)), #{restNo}, #{menuName}, #{menuContent}, #{menuPrice}
        )
        <selectKey order="AFTER" resultType="string" keyProperty="menuNo">
            select
                ('menu' || lpad(seq_tb_menu_menu_no.currval,3,0))
            from
                dual
        </selectKey>
    </insert>

    <!-- 메뉴 수정 - 재준 -->
    <update id="updateMenu">
        update
            tb_menu
        set
            menu_name = #{menuName}
            , menu_content = #{menuContent}
            , menu_price = #{menuPrice}
        where
            menu_no = #{menuNo}
    </update>

    <!-- 메뉴 삭제 -->
    <delete id="deleteMenu">
        delete from
            tb_menu
        where
            menu_no = #{menuNo}
    </delete>

    <!-- 메뉴 이름으로 식당 식별번호 조회 - 재준 -->
    <select id="findByMenuName" resultType="String">
        select
            rest_no
        from
            tb_menu
        where
            menu_name = #{menuName}
    </select>

    <!-- 전체 게시물 조회 - 정호 -->
    <select id="getTotalCount" resultType="_int">
        select
            count(*)
        from
            menu m join menu_picture p
                        on m.no = p.menu_no
    </select>

    <!-- 페이지 별 게시물 조회 - 정호 -->
    <select id="findAll" resultMap="menuVoMap">
        select
            m.*,
            p.no pic_no,
            p.menu_no,
            p.renamed_filename
        from
            menu m left join menu_picture p
                        on m.no = p.menu_no
    </select>
    <resultMap id="menuVoMap" type="menuVo">
        <id column="no" property="no"/>
        <result column="rest_no" property="restNo"/>
        <result column="name" property="name"/>
        <result column="content" property="content"/>
        <result column="price" property="price"/>
        <collection property="menuPictures" ofType="menuPicture">
            <id column="pic_no" property="no"/>
            <result column="menu_no" property="menuNo"/>
            <result column="renamed_filename" property="renamedFilename"/>
        </collection>
    </resultMap>
</mapper>